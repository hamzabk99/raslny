<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="chatApp">
    <!-- User List Sidebar -->
    <div id="userList">
      <div id="userHeader">
        <img id="userPhoto" alt="Your photo">
        <span id="userName"></span>
        <button onclick="signOut()" id="signOutBtn">Sign Out</button>
      </div>
      <h3>Contacts</h3>
      <div id="users"></div>
    </div>

    <!-- Chat Window -->
    <div id="chatWindow">
      <div id="chatHeader">
        <span id="currentChat">Select a contact to chat</span>
      </div>
      <div id="messages"></div>
      <div class="input-container">
        <input id="messageInput" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

  <script>
    // Replace with your Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyA3h2VF-GeE_AKjKcsbDF-zw1n1Y9Z_ckA",
        authDomain: "web-chat-eaa23.firebaseapp.com",
        projectId: "web-chat-eaa23",
        storageBucket: "web-chat-eaa23.firebasestorage.app",
        messagingSenderId: "640664372760",
        appId: "1:640664372760:web:8b44f49ac91a4465b1256d"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;
    let currentReceiver = null;

    // Authentication functions
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch(error => {
          console.error("Error during sign in:", error);
        });
    }

    function signOut() {
      auth.signOut()
        .then(() => {
          window.location.reload();
        })
        .catch(error => {
          console.error("Error during sign out:", error);
        });
    }

    // Listen for auth state changes
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('userPhoto').src = user.photoURL;
        document.getElementById('userName').textContent = user.displayName;
        checkUserExists(user);
        loadUsers();
      } else {
        // Prompt sign in if no user is authenticated
        signInWithGoogle();
      }
    });

    // Check or create the user document in Firestore
    function checkUserExists(user) {
      const userRef = db.collection('users').doc(user.uid);
      userRef.get()
        .then(doc => {
          if (!doc.exists) {
            return userRef.set({
              uid: user.uid,
              displayName: user.displayName,
              email: user.email,
              photoURL: user.photoURL,
              lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        })
        .catch(error => {
          console.error("Error checking/creating user:", error);
        });
    }

    // Load all contacts (other users)
    function loadUsers() {
      db.collection('users').onSnapshot(snapshot => {
        const usersDiv = document.getElementById('users');
        usersDiv.innerHTML = '';
        
        snapshot.forEach(doc => {
          const user = doc.data();
          if (user.uid !== currentUser.uid) {
            // Escape single quotes in the display name for safe insertion in the onclick attribute.
            const safeDisplayName = user.displayName.replace(/'/g, "\\'");
            usersDiv.innerHTML += `
              <button class="user-item" onclick="openChat('${user.uid}', '${safeDisplayName}')">
                <img src="${user.photoURL}" class="user-avatar">
                ${user.displayName}
              </button>
            `;
          }
        });
      }, error => {
        console.error("Error loading users:", error);
      });
    }

    // Open chat with a selected contact
    function openChat(receiverId, receiverName) {
      currentReceiver = receiverId;
      document.getElementById('currentChat').textContent = receiverName;
      loadMessages();
    }

    // Load chat history for the active conversation
    function loadMessages() {
      if (!currentReceiver) return;
      
      const chatId = [currentUser.uid, currentReceiver].sort().join('_');
      const messagesRef = db.collection(`chats/${chatId}/messages`).orderBy('timestamp');

      messagesRef.onSnapshot(snapshot => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        snapshot.forEach(doc => {
          const msg = doc.data();
          const isYou = msg.sender === currentUser.uid;
          const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '';
          
          messagesDiv.innerHTML += `
            <div class="message ${isYou ? 'you' : 'others'}">
              <div class="text">${msg.text}</div>
              <span class="timestamp">${timestamp}</span>
            </div>
          `;
        });
        // Auto-scroll to the latest message
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, error => {
        console.error("Error loading messages:", error);
      });
    }

    // Send a message to the active conversation
    function sendMessage() {
      if (!currentUser) {
        alert("You are not authenticated. Please sign in.");
        return;
      }
      if (!currentReceiver) {
        alert("Please select a contact to chat with.");
        return;
      }

      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) return;

      const chatId = [currentUser.uid, currentReceiver].sort().join('_');
      
      db.collection(`chats/${chatId}/messages`).add({
        text: text,
        sender: currentUser.uid,
        receiver: currentReceiver,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        input.value = "";
      })
      .catch(error => {
        console.error("Error sending message:", error);
      });
    }
  </script>
</body>
</html>
