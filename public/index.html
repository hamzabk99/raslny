<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="styles.css?v=10">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div id="authScreen">
    <div class="auth-container">
      <h1>Chat</h1>
      <button class="google-btn" onclick="signInWithGoogle()">
        <img src="https://www.google.com/favicon.ico" alt="Google Icon">
        Sign in with Google
      </button>
    </div>
  </div>

  <div id="chatApp" style="display: none;">
    <div id="userList">
      <div id="userHeader">
        <img id="userPhoto" alt="Your photo">
        <span id="userName"></span>
        <button onclick="showProfile()" id="profileBtn">Profile</button>
        <button onclick="signOut()" id="signOutBtn">Sign Out</button>
      </div>
      <div id="searchContainer">
        <input id="searchInput" placeholder="Search by username..." oninput="searchUsers()">
        <div id="searchResults"></div>
      </div>
      <div id="users"></div>
    </div>
    <div id="chatWindow" style="display: none;">
      <div id="chatHeader">
        <button class="back-btn" onclick="showUserList()">←</button>
        <span id="currentChat">Select a contact</span>
      </div>
      <div id="messages"></div>
      <div class="input-container">
        <input id="messageInput" placeholder="Type a message..." onkeydown="if (event.key === 'Enter') sendMessage()" />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
    <div id="profilePage" style="display: none;">
      <div id="profileHeader">
        <button class="back-btn" onclick="showUserList()">←</button>
        <h2>Profile</h2>
      </div>
      <div id="profileContent">
        <img id="profilePhoto" alt="Your photo">
        <input id="profileName" placeholder="Your Name">
        <input id="profileUsername" placeholder="Your Username">
        <button onclick="saveProfile()">Save</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3h2VF-GeE_AKjKcsbDF-zw1n1Y9Z_ckA",
      authDomain: "web-chat-eaa23.firebaseapp.com",
      projectId: "web-chat-eaa23",
      storageBucket: "web-chat-eaa23.firebasestorage.app",
      messagingSenderId: "640664372760",
      appId: "1:640664372760:web:8b44f49ac91a4465b1256d"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;
    let currentReceiver = null;

    function signInWithGoogle() {
      console.log("Sign-in button clicked");
      const provider = new firebase.auth.GoogleAuthProvider();
      return auth.signInWithPopup(provider)
        .then((result) => {
          console.log("Sign-in successful:", result.user.uid);
        })
        .catch(error => {
          console.error("Sign-in error:", error.code, error.message);
          alert("Failed to sign in: " + error.message);
        });
    }

    function signOut() {
      auth.signOut();
      window.location.reload();
    }

    auth.onAuthStateChanged(user => {
      const authScreen = document.getElementById('authScreen');
      const chatApp = document.getElementById('chatApp');
      const userList = document.getElementById('userList');
      
      if (user) {
        currentUser = user;
        console.log("User signed in:", user.uid);
        authScreen.style.display = 'none';
        chatApp.style.display = 'flex';
        userList.classList.add('active'); // Ensure user list is visible
        document.getElementById('userPhoto').src = user.photoURL || '';
        document.getElementById('userName').textContent = user.displayName || 'User';
        checkUserExists(user);
        loadFollowing();
      } else {
        console.log("No user signed in");
        authScreen.style.display = 'flex';
        chatApp.style.display = 'none';
      }
    });

    function checkUserExists(user) {
      const userRef = db.collection('users').doc(user.uid);
      userRef.get().then(doc => {
        if (!doc.exists) {
          console.log("Creating new user document for:", user.uid);
          userRef.set({
            uid: user.uid,
            displayName: user.displayName,
            username: user.email.split('@')[0],
            email: user.email,
            photoURL: user.photoURL,
            following: [],
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            console.log("User document created");
          }).catch(error => {
            console.error("Error creating user:", error);
          });
        } else {
          console.log("User document exists:", doc.data());
        }
      }).catch(error => {
        console.error("Error checking user:", error);
      });
    }

    function loadFollowing() {
      console.log("Loading following list for:", currentUser.uid);
      const userRef = db.collection('users').doc(currentUser.uid);
      userRef.onSnapshot(doc => {
        if (doc.exists) {
          const following = doc.data().following || [];
          const usersDiv = document.getElementById('users');
          usersDiv.innerHTML = following.length ? '' : '<p>No one followed yet.</p>';
          
          following.forEach(followId => {
            db.collection('users').doc(followId).get().then(followDoc => {
              if (followDoc.exists) {
                const user = followDoc.data();
                usersDiv.innerHTML += `
                  <div class="user-item" onclick="openChat('${user.uid}', '${user.displayName}')">
                    <img src="${user.photoURL}" onerror="this.src='data:,'">
                    <span class="user-name">${user.displayName} (@${user.username})</span>
                    <span class="notification" id="notif-${user.uid}"></span>
                  </div>
                `;
              }
            }).catch(error => {
              console.error("Error fetching followed user:", error);
            });
          });
          listenForNotifications();
        } else {
          console.log("User document not found, retrying creation");
          checkUserExists(currentUser);
        }
      }, error => {
        console.error("Error in loadFollowing snapshot:", error);
      });
    }

    function searchUsers() {
      const query = document.getElementById('searchInput').value.trim().toLowerCase();
      const searchResults = document.getElementById('searchResults');
      searchResults.innerHTML = '';
      
      if (!query) return;
      
      console.log("Searching for username:", query);
      db.collection('users')
        .where('username', '>=', query)
        .where('username', '<=', query + '\uf8ff')
        .limit(5)
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const user = doc.data();
            if (user.uid !== currentUser.uid) {
              searchResults.innerHTML += `
                <div class="search-item" onclick="followUser('${user.uid}')">
                  <img src="${user.photoURL}" onerror="this.src='data:,'">
                  <span>${user.displayName} (@${user.username})</span>
                  <button>Follow</button>
                </div>
              `;
            }
          });
        }).catch(error => {
          console.error("Error searching users:", error);
        });
    }

    function followUser(userId) {
      console.log("Following user:", userId);
      const userRef = db.collection('users').doc(currentUser.uid);
      userRef.update({
        following: firebase.firestore.FieldValue.arrayUnion(userId)
      }).then(() => {
        console.log("Successfully followed user:", userId);
        loadFollowing();
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
      }).catch(error => {
        console.error("Error following user:", error);
      });
    }

    function openChat(receiverId, receiverName) {
      currentReceiver = receiverId;
      document.getElementById('currentChat').textContent = receiverName;
      console.log("Chat opened - Sender:", currentUser.uid, "Receiver:", receiverId);
      document.getElementById('userList').classList.remove('active');
      document.getElementById('chatWindow').style.display = 'flex';
      document.getElementById('profilePage').style.display = 'none';
      loadMessages();
      const notifElement = document.getElementById(`notif-${receiverId}`);
      if (notifElement) notifElement.textContent = '';
    }

    function showUserList() {
      console.log("Showing user list");
      document.getElementById('userList').classList.add('active');
      document.getElementById('chatWindow').style.display = 'none';
      document.getElementById('profilePage').style.display = 'none';
      currentReceiver = null;
    }

    function showProfile() {
      console.log("Showing profile page");
      document.getElementById('userList').classList.remove('active');
      document.getElementById('chatWindow').style.display = 'none';
      const profilePage = document.getElementById('profilePage');
      profilePage.style.display = 'flex';
      
      const userRef = db.collection('users').doc(currentUser.uid);
      userRef.get().then(doc => {
        const data = doc.data();
        document.getElementById('profilePhoto').src = data.photoURL || '';
        document.getElementById('profileName').value = data.displayName || '';
        document.getElementById('profileUsername').value = data.username || '';
      }).catch(error => {
        console.error("Error loading profile:", error);
      });
    }

    function saveProfile() {
      const name = document.getElementById('profileName').value.trim();
      const username = document.getElementById('profileUsername').value.trim();
      if (!name || !username) {
        alert("Name and username cannot be empty");
        return;
      }
      
      console.log("Saving profile:", { name, username });
      const userRef = db.collection('users').doc(currentUser.uid);
      userRef.update({
        displayName: name,
        username: username,
        photoURL: document.getElementById('profilePhoto').src
      }).then(() => {
        console.log("Profile updated successfully");
        document.getElementById('userName').textContent = name;
        document.getElementById('userPhoto').src = document.getElementById('profilePhoto').src;
        showUserList();
      }).catch(error => {
        console.error("Error updating profile:", error);
      });
    }

    function loadMessages() {
      if (!currentReceiver) {
        console.log("No receiver selected, skipping loadMessages");
        return;
      }
      
      const chatId = [currentUser.uid, currentReceiver].sort().join('_');
      console.log("Loading messages for chatId:", chatId);
      const messagesRef = db.collection(`chats/${chatId}/messages`).orderBy('timestamp');

      messagesRef.onSnapshot(snapshot => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        snapshot.forEach(doc => {
          const msg = doc.data();
          const isYou = msg.sender === currentUser.uid;
          
          messagesDiv.innerHTML += `
            <div id="${doc.id}" class="message ${isYou ? 'you' : 'others'}">
              ${msg.text}
              <span class="timestamp">
                ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...'}
              </span>
            </div>
          `;
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, error => {
        console.error("Error loading messages:", error);
      });
    }

    function listenForNotifications() {
      console.log("Listening for notifications");
      db.collectionGroup('messages')
        .where('receiver', '==', currentUser.uid)
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const msg = change.doc.data();
              const senderId = msg.sender;
              const notifElement = document.getElementById(`notif-${senderId}`);
              if (notifElement && senderId !== currentReceiver) {
                const preview = msg.text.length > 20 ? msg.text.substring(0, 20) + '...' : msg.text;
                notifElement.textContent = preview;
                console.log(`Notification for ${senderId}: ${preview}`);
              }
            }
          });
        }, error => {
          console.error("Error listening for notifications:", error);
        });
    }

    function sendMessage() {
      if (!currentUser || !currentReceiver) {
        alert("Please select a contact to chat with.");
        console.log("Send failed: No user or receiver");
        return;
      }

      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text) {
        console.log("Send failed: Empty message");
        return;
      }

      const chatId = [currentUser.uid, currentReceiver].sort().join('_');
      console.log("Sending message to chatId:", chatId);
      
      db.collection(`chats/${chatId}/messages`).add({
        text: text,
        type: 'text',
        sender: currentUser.uid,
        receiver: currentReceiver,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log("Message sent successfully");
        input.value = "";
        loadMessages();
      }).catch(error => {
        console.error("Error sending message:", error);
        alert("Failed to send message: " + error.message);
      });
    }

    console.log("App initialized");
  </script>
</body>
</html>