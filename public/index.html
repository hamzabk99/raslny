<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Authentication Screen -->
  <div id="authScreen">
    <div class="auth-container">
      <h1>Welcome to Chat</h1>
      <button onclick="signInWithGoogle()" class="google-btn">
        <img src="https://img.icons8.com/color/48/google-logo.png" alt="Google logo">
        Sign in with Google
      </button>
    </div>
  </div>

  <!-- Chat Application -->
  <div id="chatApp" style="display: none;">
    <!-- User List Sidebar -->
    <div id="userList">
      <div id="userHeader">
        <img id="userPhoto" alt="Your photo">
        <span id="userName"></span>
        <button onclick="signOut()" id="signOutBtn">Sign Out</button>
      </div>
      <h3>Contacts</h3>
      <div id="users"></div>
    </div>

    <!-- Chat Window -->
    <div id="chatWindow">
      <div id="chatHeader">
        <span id="currentChat">Select a contact to start chatting</span>
      </div>
      <div id="messages"></div>
      <div class="input-container">
        <input id="messageInput" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

  <script>
    // Replace with your Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyA3h2VF-GeE_AKjKcsbDF-zw1n1Y9Z_ckA",
        authDomain: "web-chat-eaa23.firebaseapp.com",
        projectId: "web-chat-eaa23",
        storageBucket: "web-chat-eaa23.firebasestorage.app",
        messagingSenderId: "640664372760",
        appId: "1:640664372760:web:8b44f49ac91a4465b1256d"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    let currentUser = null;
    let currentReceiver = null;

    // Authentication Functions
    function signInWithGoogle() {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          console.log("Mobile device detected, using redirect");
          auth.signInWithRedirect(provider);
        } else {
          console.log("Desktop device detected, using popup");
          auth.signInWithPopup(provider).catch(error => {
            console.error("Sign-in error:", error);
            alert("Sign-in failed: " + error.message);
          });
        }
      } catch (error) {
        console.error("Sign-in exception:", error);
        alert("Authentication error: " + error.message);
      }
    }

    // Handle mobile redirect
    auth.getRedirectResult().catch(error => {
      console.error("Redirect error:", error);
      alert("Redirect sign-in failed: " + error.message);
    });

    function signOut() {
      auth.signOut()
        .then(() => {
          console.log("User signed out successfully");
          currentUser = null;
          currentReceiver = null;
          document.getElementById('chatApp').style.display = 'none';
          document.getElementById('authScreen').style.display = 'block';
        })
        .catch(error => {
          console.error("Sign-out error:", error);
          alert("Sign-out failed: " + error.message);
        });
    }

    // Auth State Management
    auth.onAuthStateChanged(user => {
      const authScreen = document.getElementById('authScreen');
      const chatApp = document.getElementById('chatApp');
      
      try {
        if (user) {
          console.log("User authenticated:", user.uid);
          currentUser = user;
          authScreen.style.display = 'none';
          chatApp.style.display = 'grid';
          document.getElementById('userPhoto').src = user.photoURL;
          document.getElementById('userName').textContent = user.displayName;
          checkUserExists(user);
          loadUsers();
        } else {
          console.log("No authenticated user");
          chatApp.style.display = 'none';
          authScreen.style.display = 'block';
        }
      } catch (error) {
        console.error("Auth state error:", error);
      }
    });

    // User Management
    function checkUserExists(user) {
      const userRef = db.collection('users').doc(user.uid);
      userRef.get().then(doc => {
        if (!doc.exists) {
          console.log("Creating new user document");
          userRef.set({
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }).catch(error => {
        console.error("User check error:", error);
      });
    }

    // Chat Functions
    function loadUsers() {
      console.log("Loading users...");
      db.collection('users').onSnapshot(snapshot => {
        const usersDiv = document.getElementById('users');
        usersDiv.innerHTML = '';
        
        snapshot.forEach(doc => {
          const user = doc.data();
          if (user.uid !== currentUser.uid) {
            usersDiv.innerHTML += `
              <button class="user-item" onclick="openChat('${user.uid}', '${user.displayName}')">
                <img src="${user.photoURL}" class="user-avatar">
                ${user.displayName}
              </button>
            `;
          }
        });
      }, error => {
        console.error("Users load error:", error);
        alert("Error loading contacts: " + error.message);
      });
    }

    function openChat(receiverId, receiverName) {
      try {
        console.log("Opening chat with:", receiverId);
        currentReceiver = receiverId;
        document.getElementById('currentChat').textContent = receiverName;
        loadMessages();
      } catch (error) {
        console.error("Open chat error:", error);
      }
    }

    function loadMessages() {
      if (!currentReceiver) {
        console.log("No receiver selected");
        return;
      }
      
      try {
        const chatId = [currentUser.uid, currentReceiver].sort().join('_');
        console.log("Loading messages for chat:", chatId);
        
        const messagesRef = db.collection(`chats/${chatId}/messages`).orderBy('timestamp');
        
        messagesRef.onSnapshot(snapshot => {
          const messagesDiv = document.getElementById('messages');
          messagesDiv.innerHTML = '';
          
          snapshot.forEach(doc => {
            const msg = doc.data();
            const isYou = msg.sender === currentUser.uid;
            
            messagesDiv.innerHTML += `
              <div class="message ${isYou ? 'you' : 'others'}">
                <div class="text">${msg.text}</div>
                <span class="timestamp">
                  ${new Date(msg.timestamp?.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
              </div>
            `;
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, error => {
          console.error("Messages load error:", error);
          alert("Error loading messages: " + error.message);
        });
        
      } catch (error) {
        console.error("Load messages error:", error);
      }
    }

    function sendMessage() {
      try {
        if (!auth.currentUser) {
          alert("You need to sign in first!");
          return;
        }
        
        if (!currentReceiver) {
          alert("Select a contact first!");
          return;
        }

        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text) {
          alert("Message cannot be empty!");
          return;
        }

        const chatId = [currentUser.uid, currentReceiver].sort().join('_');
        console.log("Sending message to chat:", chatId);
        
        db.collection(`chats/${chatId}/messages`).add({
          text: text,
          sender: currentUser.uid,
          receiver: currentReceiver,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(docRef => {
          console.log("Message sent successfully, ID:", docRef.id);
        }).catch(error => {
          console.error("Message send error:", error);
          alert("Failed to send message: " + error.message);
        });

        input.value = "";
      } catch (error) {
        console.error("Send message error:", error);
        alert("Error sending message: " + error.message);
      }
    }
  </script>
</body>
</html>